<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<!-- Verificación de sesión -->
<f:metadata>
    <f:event type="preRenderView" listener="#{loginUI.verificarSesion}"></f:event>
</f:metadata>


<h:head>
    <title>Gestor de Usuarios</title>
    <h:outputStylesheet name="style.css"/>
    <script src="resources/funct.js"></script>
</h:head>

<h:body>
    <!-- Encabezado con botones -->
    <div class="header">
        <h:link outcome="indexGerente.xhtml" styleClass="back ui-button-success">
            <i class="pi pi-arrow-left"></i>
        </h:link>
        <span>Gestor de usuarios</span>
        <p:commandButton class="menu" icon="pi pi-bars" onclick="toggleMenu(); return false;" />
    </div>

    <!-- Menú superior -->
    <div id="menuPanel" class="menu-panel">
        <h:link outcome="consulta_materiales.xhtml" styleClass="menu-option">
            <i class="pi pi-box"></i> Consulta Materiales
        </h:link>
        <h:link outcome="consulta_usuarios.xhtml" styleClass="menu-option">
            <i class="pi pi-users"></i> Consulta Usuarios
        </h:link>
        <h:link outcome="consulta_cotizaciones.xhtml" styleClass="menu-option">
            <i class="pi pi-file"></i> Consulta Cotizaciones
        </h:link>
    </div>

    <!-- PRINCIPAL -->
    <h:form id="formUsuarios" styleClass="cuerpo-gestores">

        <p:panel styleClass="catalogo-panel">
            <br/>

            <h:link outcome="registroUsuario.xhtml" styleClass="menu-option">
                <i class="pi pi-box"></i> Agregar Usuario
            </h:link>

            <!-- Barras de búsqueda -->
            <div class="searchbar">
                <i class="pi pi-search"></i>
                <p:inputText id="nombreBusqueda" value="#{usuarioBean.nombreBusqueda}"
                             placeholder="Buscar por nombre" styleClass="search-input">
                    <p:ajax event="keyup" listener="#{usuarioBean.aplicarFiltro}"
                            update="tablaUsuarios" delay="500"/>
                </p:inputText>
                <i class="pi pi-search">    </i>
                <p:inputText id="idBusqueda"
                             value="#{usuarioBean.idBusqueda}"
                             placeholder="Buscar por ID"
                             styleClass="search-input"
                             style="margin-left:10px;">
                    <p:ajax event="keyup"
                            process="@form"
                            listener="#{usuarioBean.aplicarFiltro}"
                            update="tablaUsuarios"
                            delay="100"/>
                </p:inputText>

                <p:commandButton value="Mostrar todos"
                                 icon="pi pi-refresh"
                                 actionListener="#{usuarioBean.recargarUsuarios}"
                                 update="tablaUsuarios"
                                 styleClass="btn-azul-iconoblanco btn-refresh"/>
            </div>

            <br/><br/>

            <!-- Tabla de usuarios -->
            <p:dataTable id="tablaUsuarios"
                         value="#{usuarioBean.listaFiltrada}"
                         var="usuario"
                         responsiveLayout="scroll"
                         emptyMessage="Sin usuarios registrados"
                         rowHover="true"
                         paginator="false"
                         styleClass="ua-table custom-table-skin">

                <p:column headerText="ID" style="width:80px;">
                    <h:outputText value="#{usuario.id}" />
                </p:column>

                <p:column headerText="Nombre Usuario">
                    <h:outputText value="#{usuario.nombre}" />
                </p:column>

                <p:column headerText="Apellidos">
                    <h:outputText value="#{usuario.apellidoPrim} #{usuario.apellidoSeg}" />
                </p:column>

                <p:column headerText="RFC">
                    <h:outputText value="#{usuario.usDatosSensible.rfc}" />
                </p:column>

                <p:column headerText="Correo Electrónico">
                    <h:outputText value="#{usuario.usDatosSensible.email}" />
                </p:column>

                <p:column headerText="Acciones" style="width:100px; text-align:center;">
                    <div class="action-buttons">
                        <!-- Modificacion: abre diálogo -->

                        <p:commandButton icon="pi pi-pencil"
                                         title="Editar"
                                         styleClass="ui-button-flat pencil-icon"
                                         actionListener="#{usuarioBean.setUsuarioSeleccionado(usuario)}"
                                         update=":formDialog"
                                         oncomplete="PF('dlgEditar').show()"/>

                        <p:commandButton icon="pi pi-times"
                                         title="Activar/Desactivar"
                                         styleClass="ui-button-flat delete-icon"
                                         actionListener="#{usuarioBean.prepararCambioEstado(usuario)}"
                                         update=":formConfirmar"
                                         oncomplete="PF('dlgConfirmarEstado').show()"/>
                    </div>
                </p:column>
            </p:dataTable>
        </p:panel>
    </h:form>

    <!-- Modificacion de correo y contraseña -->
    <h:form id="formDialog">
        <p:dialog id="dlgEditar"
                  header="Editar Correo y Contraseña"
                  widgetVar="dlgEditar"
                  modal="true"
                  resizable="false"
                  closable="true"
                  showEffect="fade"
                  hideEffect="fade"
                  width="400">

            <h:panelGrid id="editDialogForm" columns="1" cellpadding="5">
                <p:messages id="msgs" autoUpdate="true"/>

                <h:outputLabel for="email" value="Correo Electrónico:"/>
                <p:inputText id="email" value="#{usuarioBean.usuarioSeleccionado.usDatosSensible.email}"
                             placeholder="Correo electrónico" required="true"/>

                <h:outputLabel for="psswd" value="Contraseña:"/>
                <p:password id="psswd" value="#{usuarioBean.usuarioSeleccionado.usPsswd.psswd}"
                            placeholder="Contraseña" feedback="true" required="true"/> <!-- feedback: if its weak or strong password -->

                <div style="margin-top:10px;">
                    <p:commandButton value="Guardar cambios"
                                     action="#{usuarioBean.guardarCambios}"
                                     update=":formUsuarios:tablaUsuarios, :formDialog:msgs"
                                     oncomplete="PF('dlgEditar').hide()"
                                     styleClass="ui-button-success"/>

                    <p:commandButton value="Cancelar"
                                     actionListener="#{usuarioBean.cancelarEdicion}"
                                     update=":formDialog:editDialogForm"
                                     onclick="PF('dlgEditar').hide(); return false;"
                                     styleClass="ui-button-secondary"/>
                </div>
            </h:panelGrid>
        </p:dialog>
    </h:form>


    <!-- Activacion/Desactivacion -->
    <h:form id="formConfirmar">
        <p:dialog header="Confirmar acción" widgetVar="dlgConfirmarEstado" modal="true" resizable="false">
            <h:panelGrid columns="1" cellpadding="5">
                <h:outputText value="¿Desea #{usuarioBean.usuarioSeleccionado.estado ? 'desactivar' : 'activar'} al usuario #{usuarioBean.usuarioSeleccionado.nombre} #{usuarioBean.usuarioSeleccionado.apellidoPrim}?" />
                <h:panelGroup layout="block" style="text-align:center; margin-top:10px;">
                    <p:commandButton value="Sí"
                                     action="#{usuarioBean.cambiarEstadoUsuario}"
                                     update=":formUsuarios:tablaUsuarios, :formUsuarios:msgs"
                                     oncomplete="PF('dlgConfirmarEstado').hide()"
                                     styleClass="ui-button-success"
                                     style="margin-right:10px;" />

                    <p:commandButton value="No"
                                     onclick="PF('dlgConfirmarEstado').hide(); return false;"
                                     styleClass="ui-button-secondary" />
                </h:panelGroup>
            </h:panelGrid>
        </p:dialog>
    </h:form>

</h:body>
</html>
