<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<!-- Verificación de sesión -->
<f:metadata>
    <f:event type="preRenderView" listener="#{loginUI.verificarSesion}"></f:event>
</f:metadata>

<h:head>
    <title>Gestor de Cotizaciones</title>
    <link href="resources/style.css" rel="stylesheet"/>
    <script src="resources/funct.js"></script>
</h:head>
<h:body>
    <!-- Encabezado con botones -->
    <div class="header">
        <!-- Link para regresar -->
        <h:link outcome="indexVendedor.xhtml" styleClass="back ui-button-success">
            <i class="pi pi-arrow-left"></i>
        </h:link>

        <span>Gestor de Cotizaciones</span>

        <!-- Botón de menú -->
        <p:commandButton class="menu" icon="pi pi-bars"
                         onclick="toggleMenu(); return false;" />
    </div>

    <!-- Menú superior oculto -->
    <div id="menuPanel" class="menu-panel">
        <h:link outcome="indexVendedor.xhtml" styleClass="menu-option">
            <i class="pi pi-box"></i> Indice
        </h:link>

        <h:link outcome="consulta_cotizaciones_vendedor.xhtml" styleClass="menu-option">
            <i class="pi pi-users"></i> Consulta Cotizaciones
        </h:link>

        <h:link outcome="registroCotizacionVendedor.xhtml" styleClass="menu-option">
            <i class="pi pi-file"></i> Registrar Cotizacion
        </h:link>
    </div>

    <h:form id="formCotizaciones" styleClass="cuerpo-gestores">

        <!-- Panel principal del catálogo -->
        <p:panel styleClass="catalogo-panel">
            <br/>

            <!--Para ir al registro-->
            <h:link outcome="registroCotizacion.xhtml" styleClass="menu-option">
                <i class="pi pi-box"></i> Agregar Cotización
            </h:link>
            <br/>
            <br/>

            <!-- Filtros -->
            <div class="filter-bar" style="display:flex; flex-direction: column; gap:12px;">
                <div style="display:flex; flex-wrap:wrap; gap:10px;">
                    <p:commandButton value="Ordenar por fecha"
                                    icon="pi pi-calendar"
                                     actionListener="#{cotizacionUI.consultarPorFecha}"
                                     update="tablaCotizaciones"
                                     styleClass="btn-azul-iconoblanco"/>

                    <p:commandButton value="Ordenar por folio"
                                     icon="pi pi-sort-numeric-up"
                                     actionListener="#{cotizacionUI.consultarPorFolio}"
                                     update="tablaCotizaciones"
                                     styleClass="btn-azul-iconoblanco"/>

                </div>

                <div style="display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-top:8px;">
                    <p:selectOneMenu id="anioFiltro" value="#{cotizacionUI.anioFiltro}" style="width:120px;">
                        <f:selectItem itemLabel="Año" itemValue="" noSelectionOption="true"/>
                        <f:selectItems value="#{cotizacionUI.aniosDisponibles}" var="anio"
                                       itemValue="#{anio}" itemLabel="#{anio}"/>
                    </p:selectOneMenu>

                    <p:commandButton value="Filtrar por año"
                                     icon="pi pi-filter"
                                     actionListener="#{cotizacionUI.obtenerPorAnio}"
                                     update="tablaCotizaciones"
                                     styleClass="btn-azul-iconoblanco"/>

                    <p:selectOneMenu id="mesFiltro" value="#{cotizacionUI.mesFiltro}" style="width:120px;">
                        <f:selectItem itemLabel="Mes" itemValue="" noSelectionOption="true"/>
                        <f:selectItems value="#{cotizacionUI.mesesDisponibles}" var="mes"
                                       itemValue="#{mes}" itemLabel="#{cotizacionUI.obtenerNombreMes(mes)}"/>
                    </p:selectOneMenu>

                    <p:commandButton value="Filtrar por mes"
                                     icon="pi pi-filter"
                                     actionListener="#{cotizacionUI.obtenerPorMes}"
                                     update="tablaCotizaciones"
                                     styleClass="btn-azul-iconoblanco"/>
                </div>
            </div>
            <br/>

            <!-- Tabla de cotizaciones -->
            <p:dataTable id="tablaCotizaciones"
                         value="#{cotizacionUI.cotizaciones}"
                         var="c"
                         responsiveLayout="scroll"
                         emptyMessage="Sin cotizaciones registradas"
                         rowHover="true"
                         paginator="false"
                         styleClass="ua-table custom-table-skin">

                <p:column headerText="ID Folio" style="width:80px;">
                    <h:outputText value="#{c.id}" />
                </p:column>

                <p:column headerText="Cliente">
                    <h:outputText value="#{c.cliente}" />
                </p:column>

                <p:column headerText="Tipo del Proyecto">
                    <h:outputText value="#{c.tipoProyecto}" />
                </p:column>

                <p:column headerText="Fecha">
                    <h:outputText value="#{c.fecha}">
                        <f:convertDateTime type="localDate" pattern="dd/MM/yyyy"/>
                    </h:outputText>
                </p:column>

                <p:column headerText="Vendedor">
                    <h:outputText value="#{c.idUsuario.nombre}"/>
                </p:column>

                <!-- PBI-CO-US18 Aprobación de Cotización-->
                <p:column headerText="Cotización">
                    <h:panelGroup>
                        <h:outputText value="Aprobado" styleClass="badge-success"
                                      rendered="#{c.isCotizacionAprobada}"/>
                        <p:commandButton value="Aprobar"
                                         icon="pi pi-check"
                                         rendered="#{!c.isCotizacionAprobada}"
                                         actionListener="#{cotizacionUI.mostrarDialogoAprobacion(c)}"
                                         update=":formCotizaciones"
                                         oncomplete="PF('dlgAprobacion').show()"
                                         process="@this"
                                         styleClass="btn-verde"/>
                    </h:panelGroup>
                </p:column>


                <!-- PBI-CO-US20 Aprobación de Contrato -->
                <p:column headerText="Contrato" style="text-align:center;">
                    <h:panelGroup>
                        <!-- Mostrar badge si YA está aprobado -->
                        <h:outputText value="Aprobado"
                                      styleClass="badge-success"
                                      rendered="#{c.isContratoAprobado}" />

                        <!-- Botón para aprobar contrato SOLO si la cotización está aprobada -->
                        <p:commandButton value="Aprobar"
                                         icon="pi pi-check"
                                         rendered="#{!c.isContratoAprobado and c.isCotizacionAprobada}"
                                         actionListener="#{cotizacionUI.mostrarDialogoAprobacionContrato(c)}"
                                         update=":formCotizaciones"
                                         oncomplete="PF('dlgAprobacionContrato').show()"
                                         process="@this"
                                         styleClass="btn-verde"/>

                        <!-- Mensaje o badge si la cotización no está aprobada -->
                        <h:outputText value="Debe aprobar la cotización"
                                      styleClass="badge-warning"
                                      rendered="#{!c.isCotizacionAprobada}" />
                    </h:panelGroup>
                </p:column>


                <p:column headerText="Acciones"
                          style="width:100px; text-align:center;">
                    <div class="action-buttons">
                        <p:commandButton icon="pi pi-pencil"
                                         title="Editar"
                                         styleClass="ui-button-flat pencil-icon"/>
                        <p:commandButton icon="pi pi-trash"
                                         title="Eliminar"
                                         styleClass="ui-button-flat delete-icon"/>
                        <p:commandButton icon="pi pi-send"
                                         title="Enviar correo"
                                         actionListener="#{cotizacionUI.enviarCorreo(c)}"
                                         update="@form"
                                         styleClass="ui-button-flat pencil-icon"/>
                        <p:commandButton icon="pi pi-file"
                                         title="Enviar contrato"
                                         actionListener="#{cotizacionUI.enviarContrato(c)}"
                                         update="@form"
                                         styleClass="ui-button-flat pencil-icon"/>
                    </div>
                </p:column>
            </p:dataTable>
        </p:panel>

        <!-- DialogContización -->
        <p:dialog id="dialogAprobacion"
                  header="Aprobar Cotización"
                  widgetVar="dlgAprobacion"
                  modal="true"
                  resizable="false"
                  closable="false"
                  visible="#{cotizacionUI.dialogAprobacionVisible}"
                  style="width:350px;">

            <h:panelGrid columns="1" cellpadding="6" style="text-align:center;">
                <h:outputText value="Para aprobar la cotización 0#{cotizacionUI.idCotizacionSeleccionada}, escriba 'Aprobado':"/>
                <p:inputText value="#{cotizacionUI.textoConfirmacion}"
                             placeholder="Escriba aquí"
                             style="width:100%; text-align:center;"/>

                <p:commandButton value="OK"
                                 icon="pi pi-check"
                                 actionListener="#{cotizacionUI.aprobarCotizacion}"
                                 update="tablaCotizaciones growl"
                                 oncomplete="PF('dlgAprobacion').hide()"
                                 process="@form"/>

                <p:commandButton value="Cancelar"
                                 icon="pi pi-times"
                                 actionListener="#{cotizacionUI.cancelarAprobacion}"
                                 update="dialogAprobacion"
                                 oncomplete="PF('dlgAprobacion').hide()"
                                 styleClass="ui-button-secondary"/>
            </h:panelGrid>
        </p:dialog>

        <!-- DialogContrato-->
        <p:dialog id="dialogAprobacionContrato"
                  header="Aprobar Contrato"
                  widgetVar="dlgAprobacionContrato"
                  modal="true"
                  resizable="false"
                  closable="false"
                  visible="#{cotizacionUI.dialogAprobacionContratoVisible}"
                  style="width:350px;">

            <h:panelGrid columns="1" cellpadding="6" style="text-align:center;">
                <h:outputText value="Para aprobar el contrato del folio #{cotizacionUI.idContratoSeleccionado}, escriba 'Aprobado':"/>

                <p:inputText value="#{cotizacionUI.textoConfirmacionContrato}"
                             placeholder="Escriba aquí"
                             style="width:100%; text-align:center;"/>

                <p:commandButton value="OK"
                                 icon="pi pi-check"
                                 actionListener="#{cotizacionUI.aprobarContrato}"
                                 update="tablaCotizaciones growl"
                                 oncomplete="PF('dlgAprobacionContrato').hide()"
                                 process="@form"/>

                <p:commandButton value="Cancelar"
                                 icon="pi pi-times"
                                 actionListener="#{cotizacionUI.cancelarAprobacionContrato}"
                                 update="dialogAprobacionContrato"
                                 oncomplete="PF('dlgAprobacionContrato').hide()"
                                 styleClass="ui-button-secondary"/>
            </h:panelGrid>
        </p:dialog>


        <p:growl id="growl" showDetail="true" life="4000"/> <!-- the message in the top right -->

    </h:form>

</h:body>

</html>